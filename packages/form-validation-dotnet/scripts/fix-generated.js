/**
 * Post-processes quicktype generated C# to fix compatibility issues:
 * - Removes DateOnly/TimeOnly converters (not available in netstandard2.0)
 * - Renames the main FormConfig class correctly
 * - Consolidates duplicate option classes into SelectOption
 * - Fixes enum and property casing (DataGrid, DateRange, etc.)
 * - Adds missing AsyncValidationResult class
 * - Adds file header comment and #nullable enable
 */

const fs = require('fs');
const path = require('path');

const filePath = path.join(__dirname, '../src/Models/FormConfig.g.cs');

let content = fs.readFileSync(filePath, 'utf8');

// Check if already processed (prevents duplicate processing)
if (content.includes('<auto-generated>')) {
    console.log('File already processed, skipping');
    process.exit(0);
}

// Add file header with #nullable enable
const header = `// <auto-generated>
// This file was generated from the JSON Schema by quicktype.
// Do not edit manually. Run 'npm run generate' to regenerate.
// </auto-generated>

#nullable enable

`;
content = header + content;

// Fix the main class name - quicktype names it based on the schema $ref
content = content.replace(/public partial class FormConfig\w*/g, 'public partial class FormConfig');

// Fix enum value casing (must be done before property fixes)
content = content.replace(/\bDatagrid\b/g, 'DataGrid');
content = content.replace(/\bDaterange\b/g, 'DateRange');
content = content.replace(/\bFileupload\b/g, 'FileUpload');
content = content.replace(/\bFormref\b/g, 'FormRef');
content = content.replace(/\bTextarea\b/g, 'Textarea'); // Keep as-is, just ensuring consistency

// Fix property name casing for config properties
content = content.replace(/\bDatagridConfig\b/g, 'DataGridConfig');
content = content.replace(/\bDaterangeConfig\b/g, 'DateRangeConfig');
content = content.replace(/\bFileuploadConfig\b/g, 'FileUploadConfig');
content = content.replace(/\bFormrefConfig\b/g, 'FormRefConfig');
content = content.replace(/\bAutocompleteConfig\b(?!\s*\{)/g, 'AutocompleteConfig'); // Keep class name

// Consolidate duplicate option classes (PurpleOption, FluffyOption, FieldOption) into SelectOption
content = content.replace(/\bPurpleOption\b/g, 'SelectOption');
content = content.replace(/\bFluffyOption\b/g, 'SelectOption');
content = content.replace(/\bFieldOption\b/g, 'SelectOption');

// Remove duplicate SelectOption class definitions (keep only the first one)
const selectOptionPattern = /(\s*public partial class SelectOption\s*\{[\s\S]*?\n\s*\})/g;
let firstSelectOption = true;
content = content.replace(selectOptionPattern, (match) => {
    if (firstSelectOption) {
        firstSelectOption = false;
        return match;
    }
    return ''; // Remove duplicates
});

// Add AsyncValidationResult class (not in schema, but needed by ValidatorRegistry)
const asyncValidationResultClass = `
    /// <summary>
    /// Result of async validation
    /// </summary>
    public class AsyncValidationResult
    {
        /// <summary>
        /// Whether the validation passed
        /// </summary>
        [JsonPropertyName("valid")]
        public bool Valid { get; set; }

        /// <summary>
        /// Optional error message when validation fails
        /// </summary>
        [JsonPropertyName("message")]
        public string? Message { get; set; }
    }
`;

// Insert AsyncValidationResult after AsyncValidationConfig class (only if not already present)
if (!content.includes('class AsyncValidationResult')) {
    content = content.replace(
        /(public partial class AsyncValidationConfig[\s\S]*?\n    \})/,
        `$1\n${asyncValidationResultClass}`
    );
}

// Remove DateOnlyConverter, TimeOnlyConverter, and IsoDateTimeOffsetConverter classes
const lines = content.split('\n');
let inConverterToRemove = false;
let braceDepth = 0;
const filteredLines = [];

for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    // Skip DateOnlyConverter, TimeOnlyConverter, and IsoDateTimeOffsetConverter
    if (line.includes('public class DateOnlyConverter') ||
        line.includes('public class TimeOnlyConverter') ||
        line.includes('internal class IsoDateTimeOffsetConverter')) {
        inConverterToRemove = true;
        braceDepth = 0;
    }

    if (inConverterToRemove) {
        // Count braces to find end of class
        braceDepth += (line.match(/{/g) || []).length;
        braceDepth -= (line.match(/}/g) || []).length;

        if (braceDepth <= 0 && line.includes('}')) {
            inConverterToRemove = false;
        }
        continue; // Skip this line
    }

    // Remove converter references from Settings
    if (line.includes('new DateOnlyConverter()') ||
        line.includes('new TimeOnlyConverter()') ||
        line.includes('IsoDateTimeOffsetConverter.Singleton')) {
        continue; // Skip this line
    }

    filteredLines.push(line);
}

content = filteredLines.join('\n');

// Clean up trailing commas in the Converters list
content = content.replace(/,(\s*},)/g, '$1');

// Clean up multiple blank lines
content = content.replace(/\n{3,}/g, '\n\n');

fs.writeFileSync(filePath, content, 'utf8');

console.log('Post-processed generated C# file successfully');
